<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>IRMA Age verification</title>
	<!-- Bootstrap -->
	<link href="../../css/bootstrap.min.css" rel="stylesheet">
	<style type="text/css">
		div.huge {font-size: 300px; line-height: 1em;}
	</style>
</head>
<body>
 <div class="container">
    <div class="page-header">
    
    <h1><img alt="IRMA" src="../../img/IRMA_logo_200.png"> Age verification</h1>
    </div>
    <div class="row">
    	<div class="span8">
     <p>The website you requested has age restrictions, you have to be
		<div class="huge">
	    &gt;16
	    </div>    
    </p>
    <p>
    Please insert your IRMA card to anonymously verify your age.
    </p>
    <button id="verify" type="button" class="btn btn-primary" data-loading-text="Verifying...">Verify age</button>
    	</div>
		<div id="alerts" class="span4">
		        
		</div>
    </div>

  <object classid="clsid:8AD9C840-044E-11D1-B3E9-00805F499D93" height="10" width="10">
    <param name="code" value="org.ovchip.SmartCardJS.class" />
    <param name="archive" value="smartcardjs.jar" />
    <param name="type" value="application/x-java-applet;version=1.6" />
    <param name="scriptable" value="true" />
    <param name="mayscript" value="true" />
    <embed type="application/x-java-applet;version=1.6" hidden="true" code="org.irmacard.scjs.SmartCardJS.class" archive="../../smartcardjs.jar" scriptable="true" mayscript="true" height="10" width="10" />
  </object>
</div>
<script src="../../js/jquery.js" type="text/javascript"></script>
<script src="../../js/bootstrap.min.js" type="text/javascript"></script>
<script src="../../js/smartcardjs.js" type="text/javascript"></script>
 <script type="text/javascript">
$(function() {
	SmartCardHandler.init();
	var showAlert = function(alerttype, message) {
		// alerttype is one of 'error', 'success', 'info'
		$('<div class="alert alert-' + alerttype + '">' + message + '</div>').hide().prependTo('#alerts').slideDown('fast');
	}
	$("#verify")
		.button()
		.toggleClass('disabled',true)
		.on('click', function(event) {
		$("#verify").button('loading');
		$.ajax({
			  url: '/irma_web_service/protocols/verification/4',
			  contentType: 'application/json',
			  data: JSON.stringify({crednr: 4}),
			  type: 'POST',
			  success: function(data) {
				  console.log(data);
				  SmartCardHandler.connectFirstCard();
				  var response = SmartCardHandler.transmitCommandSet(data.commands);
				  console.log(response);
				  if (response.smartcardstatus === 'failed') {
					  $("#verify").button('reset');
					  alert('No valid >16 credential found!');
					  showAlert('error', 'No valid >16 credential found!');										  
				  } else {
					  $.ajax({
						  url: data.responseurl,
						  contentType: 'application/json',
						  data: JSON.stringify(response),
						  type: 'POST',
						  success: function(data) {
							  $("#verify").button('reset');
							  console.log('and back!');
							  console.log(data);
							  if (data.response === 'valid') {
								  alert('Found >16 credential, press OK to continue.');
								  window.location = data.url;
							  } else {
								  alert('No valid >16 credential found!');
								  showAlert('error', 'No valid >16 credential found!');
							  }
						  }
					  });
					  
				  }
			  }
		  });
	});
	
  	SmartCardHandler.bind("cardInserted", function() {
		 SmartCardHandler.connectFirstCard();
		 if (SmartCardHandler.selectApplet('6964656D6978')) {
			 showAlert('success', 'IRMA card found!');
			 $("#verify").toggleClass("disabled", false);
		 } else {
			 showAlert('error', 'Inserted card is not an IRMA card!');
		 }
	  });
  	
	  SmartCardHandler.bind("cardRemoved", function() {
		  $("#verify").toggleClass("disabled",true);
	  });
	  
	  SmartCardHandler.bind("appletReady", function() {
		  showAlert('success', 'Applet was loaded!');
		  SmartCardHandler.connectFirstCard();
		  if (SmartCardHandler.selectApplet('6964656D6978')) {
				 showAlert('success', 'IRMA card found!');
				 $("#verify").toggleClass("disabled", false);
		  }
	  });
});
</script>

</body>
</html>