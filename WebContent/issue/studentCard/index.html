<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Radboud University IRMA Student Card</title>
	<link href="../../css/irma.css" rel="stylesheet" type="text/css" />
  <link href="http://fonts.googleapis.com/css?family=Ubuntu:regular,bold&subset=Latin" rel="stylesheet" type="text/css" />
  <link href="../../css/bootstrap.css" rel="stylesheet" type="text/css" />
  <style>
    body { background-color: #eaecef; }
     #qr_overlay {
	    position: absolute;
	    text-align: center;
	    top: 0;
	    left: 0;
	    width: 100%;
	    height: 100%;
	    z-index: 10000;
	}
	#qr_overlay_background {
	    position: absolute;
	    text-align: center;
	    top: 0;
	    left: 0;
	    width: 100%;
	    height: 100%;
	    background-color: #000;
	    -moz-opacity:0.7;
	    -khtml-opacity: 0.7;
	    opacity: 0.7;
	    z-index: 10000;
	}
	#IRMA_qr_main {
	    position: absolute;
	    text-align: center;
	    top: 0;
	    left: 0;
		-moz-opacity:1.0;
	    -khtml-opacity: 1.0;
	    opacity: 1.0;
	    width: 40%;
	    height: 400px;
	    margin-left: 30%;
	    margin-right: 30%;
	    margin-top: 10%;
	    background: white;
	    z-index: 10001;
	    -moz-border-radius: 12px;
  		border-radius: 12px;
  		padding-top: 20px;
  		padding-left: 20px;
  		padding-right: 20px;
	}   
  </style>
</head>
<body>
  <div id="RU_welcome">
    <div class="container">
      <div class="page-header">
        <div class="row">
          <div class="span6">
            <img alt="Radboud University Nijmegen" src="../../img/ru_toplogo.jpg" />
          </div>
          <div class="span6">
            <h1>Issuing of student credential</h1>
          </div>
        </div>
      </div>
        
      <div class="row">
        <p>On this page you can obtain a digital student card on your IRMA card. Obviously, you will need your IRMA card and a card reader for this.</p>
        <p>The process has two steps. First, in order to receive this credential, you have to prove that you already have a SURFnet credential. Second, your university will issue the new credential on your IRMA card.</p>
        <p>Don't worry! It's self-explanatory.</p>
        <ol>
          <li>Click on the 'Load your credentials' button.</li>
          <li>Follow the instructions. You do need to enter your PIN code during the process.</li>
        </ol>
        <p style="text-align: center"><img src="../../img/irma_load_credentials.png" id="load_credentials" /></p>
      </div>
    </div>
  </div>
  
  
  <div id="qr_overlay" class="hide fade in">
  <div id="qr_overlay_background">
  </div>
  <div id="IRMA_qr_main">
  <span class="IRMA_text">Please scan this QR image with the IRMA app on your NFC-enabled phone and apply your IRMA card to your phone.</span>
  <br><img id="qr_image" src="" />
  </div>
  </div>
  
  <div id="IRMA_verify" class="hide fade in">
    <div class="IRMA_page">
      <div class="IRMA_container">
        <div class="IRMA_title">CHECKING CREDENTIAL(S)</div>
        <div class="IRMA_logo_top"><img src="../../img/irma_logo_1024px.png" width="264" height="211" /></div>
        
        <div class="IRMA_main_scherm">
          <div class="IRMA_content_icon"><img id="IRMA_status_icon" src="../../img/irma_icon_waiting_520px.png" width="130" height="130" /></div>
        
          <div class="IRMA_content_verify">
            <span class="IRMA_content_credential">SURFnet: User ID</span>
            <span class="IRMA_content_status" id="IRMA_status_text"></span>
          </div>
              
          <div class="IRMA_arrow"><img src="../../img/irma_arrow_312px.png" width="78" height="78"></div>
          <div class="IRMA_verifier_logo"><img src="../../img/RU_logo_verifier.png" width="174" /></div>          
          
          <div class="IRMA_buttons">
            <button class="IRMA_button_gray_verify">BACK</button>
            <button id="IRMA_button_usephone" class="IRMA_button_gray_verify">USE PHONE</button>
            <button id="IRMA_button_verify" class="IRMA_button_primary">WAITING FOR CARD</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="IRMA_issue" class="hide fade in">
    <div class="IRMA_page">
      <div class="IRMA_container">
        <div class="IRMA_title">LOADING CREDENTIAL(S)</div>
    
        <div class="IRMA_issuer_logo"><img src="../../img/RU_logo_issuer.png" width="650" height="110" /></div>
    
        <div class="IRMA_main_scherm">
          <div class="IRMA_content_issue">   
            <table class="IRMA_content_table">
              <tr>
                <td class="IRMA_content_credential" colspan="2">Student</td>
              </tr>
              <tr>
                <td class="IRMA_content_attribute">University</td>
                <td class="IRMA_content_value" id="field-university"></td>
              </tr>
              <tr>
                <td class="IRMA_content_attribute">Student ID</td>
                <td class="IRMA_content_value" id="field-studentid"></td>
              </tr>
              <tr>
                <td class="IRMA_content_attribute">Student Card</td>
                <td class="IRMA_content_value" id="field-studentcardnr"></td>
              </tr>              
              <tr>
                <td class="IRMA_content_attribute">Level</td>
                <td class="IRMA_content_value" id="field-level"></td>
              </tr>
            </table>
          </div>
                      
          <div class="IRMA_arrow"><img src="../../img/irma_arrow_white_312px.png" width="78" height="78"></div>
          <div class="IRMA_logo_bottom"><img src="../../img/irma_logo_1024px.png" alt="IRMA" width="186" height="149" /></div>          
          
          <div class="IRMA_buttons">
            <button class="IRMA_button_gray_issue">BACK</button>
            <button class="IRMA_button_gray_issue">HELP</button>
            <button class="IRMA_button_primary" id="IRMA_button_issue">WAITING FOR CARD</button>
          </div>
        </div>
      </div>
    </div>
  </div>



  <script src="../../js/jquery.js" type="text/javascript"></script>
  <script src="../../js/bootstrap.min.js" type="text/javascript"></script>
  <script src="../../js/smartcardjs.js" type="text/javascript"></script>
  <object classid="clsid:8AD9C840-044E-11D1-B3E9-00805F499D93" height="10" width="10">
    <param name="code" value="org.ovchip.SmartCardJS.class" />
    <param name="archive" value="smartcardjs.jar" />
    <param name="type" value="application/x-java-applet;version=1.6" />
    <param name="scriptable" value="true" />
    <param name="mayscript" value="true" />
    <embed type="application/x-java-applet;version=1.6" hidden="true" code="org.irmacard.scjs.SmartCardJS.class" archive="../../smartcardjs.jar" scriptable="true" mayscript="true" height="10" width="10" />
  </object>
	<script type="text/javascript"><!--
$(function() {
	SmartCardHandler.init();
	var response;
	var nextAction;
	var isError = function (data) {
		if ((typeof data.status) != "undefined") {
			return data.status === "error";
		} else {
			return false;
		}
	}

	var startVerify = function () {
    disableVerify(); // Reset state
		console.log("Starting IRMA verification");
		$("#IRMA_verify").fadeIn();
    $("#RU_welcome").hide();
    SmartCardHandler.bind("cardInserted", function() {
      SmartCardHandler.connectFirstCard();
      if (SmartCardHandler.selectApplet('6964656D6978')) {
        enableVerify();
      } else {
        $("#IRMA_status_icon").prop("src", "../../img/irma_icon_warning_520px.png");
        $("#IRMA_status_text").html("Inserted card is not an IRMA card");
      }
    });
    $("#IRMA_button_usephone").button().on("click",function(event) {
    	$.ajax({
            url: '/irma_web_service/protocols/issue/studentCred?qr=true',
            contentType: 'application/json',
            data: JSON.stringify({crednr: 4}),
            type: 'POST',
            success: function(data) {
              console.log(data);
              $("#qr_image").attr("src", data.qr_url);
              $("#qr_overlay").show();
              checkInterval = window.setInterval(function(){
            	  var url = data.qr_url.substring(0,data.qr_url.lastIndexOf("/")) + '/status';
            	  var attributesurl = data.qr_url.substring(0,data.qr_url.lastIndexOf("/")) + '/attributes';
            	  $.get(url,function(data) {
            		  console.log("state: " + data.status);
            		  if (data.status !== "start") {
            			  $("#qr_overlay").hide();
            			  $("#IRMA_status_icon").prop("src", "../../img/irma_icon_ready_520px.png");
            			  $("#IRMA_status_text").html("Apply your IRMA card to your phone");
            			  $("#IRMA_button_verify").html("VERIFYING...");
            		  } 
            		  if (data.status === "issueready") {
            	            $("#IRMA_status_icon").prop("src", "../../img/irma_icon_ok_520px.png");
            	            $("#IRMA_status_text").html("Hit 'CONTINUE' to proceed to the issuing step");
            	            $("#IRMA_button_verify").html("CONTINUE");
            	            $("#IRMA_button_verify").addClass("enabled");
            	            $("#IRMA_button_verify").button().on("click", function(event) {
            	              startIssue(attributesurl);
            	            });          			  
            		  }
            		  if (data.status === "error") {
            			  window.clearInterval(checkInterval);
            			  $("#IRMA_status_icon").prop("src", "../../img/irma_icon_missing_520px.png");
            		      $("#IRMA_status_text").html("Credential not found");
            		      $("#IRMA_button_verify").html("NOT FOUND");
            		  }
            		  if (data.status === "issuing") {
            			  $("#IRMA_button_issue").html("ISSUING...");
            		  }
            		  if (data.status === "success") {
            			  window.clearInterval(checkInterval);
            			  $("#IRMA_button_issue").html("DONE");
            		      $("#IRMA_button_issue").addClass("enabled");
            		      $("#IRMA_button_issue").button().on("click", function(event) {
            		        window.location = "http://www.ru.nl/cybersecurity";
            		      });
            		  }
            	  }, "json");
              },500);
            }
          });
    	
    });
    SmartCardHandler.bind("cardRemoved", function() {
      disableVerify();
    });
    if (SmartCardHandler.connectFirstCard() && SmartCardHandler.selectApplet('6964656D6978')) {
      enableVerify();
    }
	};
	
	var enableVerify = function () {
    $("#IRMA_status_icon").prop("src", "../../img/irma_icon_ready_520px.png");
    $("#IRMA_status_text").html("Hit 'VERIFY' to check your credential");
    $("#IRMA_button_verify").html("VERIFY");
		$("#IRMA_button_verify").addClass("enabled");
    $("#IRMA_button_verify").button().on("click", function(event) {
      $("#IRMA_button_verify").off("click");
      $("#IRMA_button_verify").removeClass("enabled");
      $("#IRMA_button_verify").html("VERIFYING...");
      $.ajax({
        url: '/irma_web_service/protocols/issue/studentCred',
        contentType: 'application/json',
        data: JSON.stringify({crednr: 4}),
        type: 'POST',
        success: function(data) {
          console.log(data);
          nextAction = data;
          SmartCardHandler.connectFirstCard();
          response = SmartCardHandler.transmitCommandSet(data.commands);
          console.log(response);
          finishVerify();
        }
      });
    });
	};
	
	var disableVerify = function () {
    $("#IRMA_status_icon").prop("src", "../../img/irma_icon_waiting_520px.png");
    $("#IRMA_status_text").html("Insert your IRMA card or use your phone");
    $("#IRMA_button_verify").off("click");
    $("#IRMA_button_verify").removeClass("enabled");
    $("#IRMA_button_verify").html("WAITING FOR CARD...");
	} 
	
	var finishVerify = function () {
		console.log("Finished IRMA verification");
		if (response.smartcardstatus === "failed") {
      $("#IRMA_status_icon").prop("src", "../../img/irma_icon_missing_520px.png");
      $("#IRMA_status_text").html("Credential not found");
      $("#IRMA_button_verify").html("NOT FOUND");
    } else {
			$("#IRMA_status_icon").prop("src", "../../img/irma_icon_ok_520px.png");
			$("#IRMA_status_text").html("Hit 'CONTINUE' to proceed to the issuing step");
      $("#IRMA_button_verify").html("CONTINUE");
      $("#IRMA_button_verify").addClass("enabled");
      $("#IRMA_button_verify").button().on("click", function(event) {
        startIssue2();
      });
    }
	};

	var startIssue = function (attributesurl) {
    console.log("Starting IRMA issuance");
    $("#IRMA_verify").fadeOut();
    $("#IRMA_issue").fadeIn();
  	$.ajax({
  		url: attributesurl,
  		contentType: 'application/json',
  		type: 'GET',
  		dataType: 'json',
  		success: function(data) {
		  	if( isError(data) ){
		  		console.log(data);
		  		showAlert('error', data.message);
		  		return;
		  	}
  			$("#field-university").text(data.university);
  			$("#field-studentid").text(data.studentID);
  			$("#field-studentcardnr").text(data.studentCardNumber);
  			$("#field-level").text(data.level);
  			console.log(data);
  			$("#IRMA_status_icon").prop("src", "../../img/irma_icon_ready_520px.png");
  			$("#IRMA_button_issue").html("CONFIRM ON PHONE");
  		}
  	});
	};
	var startIssue2 = function () {
	    console.log("Starting IRMA issuance");
	    $("#IRMA_verify").fadeOut();
	    $("#IRMA_issue").fadeIn();
	  	$.ajax({
	  		url: nextAction.responseurl,
	  		contentType: 'application/json',
	  		data: JSON.stringify(response),
	  		type: 'POST',
	  		success: function(data) {
			  	if( isError(data) ){
			  		console.log(data);
			  		showAlert('error', data.message);
			  		return;
			  	}
			    var attributesurl = nextAction.responseurl.substring(0,nextAction.responseurl.lastIndexOf("/")) + '/attributes';
			  	$.ajax({
			  		url: attributesurl,
			  		contentType: 'application/json',
			  		type: 'GET',
			  		dataType: 'json',
			  		success: function(data) {
					  	if( isError(data) ){
					  		console.log(data);
					  		showAlert('error', data.message);
					  		return;
					  	}
			  			$("#field-university").text(data.university);
			  			$("#field-studentid").text(data.studentID);
			  			$("#field-studentcardnr").text(data.studentCardNumber);
			  			$("#field-level").text(data.level);
			  			console.log(data);
			  		}
			  	});
	  			console.log(data);
	  			nextAction = data;
	 		    SmartCardHandler.bind("cardInserted", function() {
	 		      SmartCardHandler.connectFirstCard();
			      if (SmartCardHandler.selectApplet('6964656D6978')) {
			        enableIssue();
			      } else {
			        $("#IRMA_status_icon").prop("src", "../../img/irma_icon_warning_520px.png");
			        $("#IRMA_status_text").html("Inserted card is not an IRMA card");
			      }
			    });
			    SmartCardHandler.bind("cardRemoved", function() {
			      disableIssue();
			    });
			    if (SmartCardHandler.connectFirstCard() && SmartCardHandler.selectApplet('6964656D6978')) {
	          enableIssue();
		      }
	  		}
	  	})
		};

  var enableIssue = function () {
    $("#IRMA_status_icon").prop("src", "../../img/irma_icon_ready_520px.png");
    $("#IRMA_status_text").html("Hit 'VERIFY' to check your credential");
    $("#IRMA_button_issue").addClass("enabled");
    $("#IRMA_button_issue").html("ISSUE");
    $("#IRMA_button_issue").button().on('click', function(event) {
      $("#IRMA_button_issue").off("click");
      $("#IRMA_button_issue").removeClass("enabled");
      $("#IRMA_button_issue").html("ISSUING...");   	
    	console.log(SmartCardHandler.applet.verifyPin());
      response = SmartCardHandler.transmitCommandSet(nextAction.commands);
      console.log(response);
      $.ajax({
        url: nextAction.responseurl,
        contentType: 'application/json',
        data: JSON.stringify(response),
        type: 'POST',
        success: function(data) {
          console.log('and back once more! Got final part of issuance data');
          console.log(data);
          var response = SmartCardHandler.transmitCommandSet(data.commands);
          console.log(response);
          finishIssue(response);
        }
      });
    });
  };

  var disableIssue = function () {
	    $("#IRMA_status_icon").prop("src", "../../img/irma_icon_waiting_520px.png");
	    $("#IRMA_status_text").html("Insert your IRMA card or use your phone");
	    $("#IRMA_button_issue").off("click");
	    $("#IRMA_button_issue").removeClass("enabled");
	    $("#IRMA_button_issue").html("WAITING FOR CARD...");	  
  };
  
	var finishIssue = function (response) {
    console.log("Finished IRMA issuance");
    if (response.smartcardstatus === "failed") {
      $("#IRMA_status_icon").prop("src", "../../img/irma_icon_missing_520px.png");
      $("#IRMA_status_text").html("Credential not issued");
      $("#IRMA_button_issue").html("NOT ISSUED");
    } else {
      $("#IRMA_status_icon").prop("src", "../../img/irma_icon_ok_520px.png");
      $("#IRMA_status_text").html("Hit 'DONE' to go back to the main page");
      $("#IRMA_button_issue").html("DONE");
      $("#IRMA_button_issue").addClass("enabled");
      $("#IRMA_button_issue").button().on("click", function(event) {
        window.location = "http://www.ru.nl/cybersecurity";
      });
    }
	}
	$("#verify").button().toggleClass('disabled', false);
	$("#cancel-issue-button").button().on('click', function(e) { $("#check-modal").fadeOut()});
	$("#result-button").button().on('click', function(e) { $("#result-modal").fadeOut()});
	var showAlert = function(alerttype, message) {
		// alerttype is one of 'error', 'success', 'info'
		$('<div class="alert alert-' + alerttype + '">' + message + '</div>').hide().prependTo('#alerts').slideDown('fast');
	};
	
	$("#load_credentials").on("click", function() {
		startVerify();
	});
	
  	SmartCardHandler.bind("cardInserted", function() {
		 SmartCardHandler.connectFirstCard();
		 if (SmartCardHandler.selectApplet('6964656D6978')) {
			 enableVerify();
			 enableIssue();
		 } else {
			 showAlert('error', 'Inserted card is not an IRMA card!');
		 }
	  });
  	
	  SmartCardHandler.bind("appletReady", function() {
		  showAlert('success', 'Applet was loaded!');
		  SmartCardHandler.connectFirstCard();
		  if (SmartCardHandler.selectApplet('6964656D6978')) {
				 showAlert('success', 'IRMA card found!');
				 $("#verify").toggleClass("disabled", false);
		  }
	  });
});
//--></script>
</body>