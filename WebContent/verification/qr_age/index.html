<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>IRMA Age verification</title>
  <link href="../../css/irma.css" rel="stylesheet" type="text/css" />
  <link href="http://fonts.googleapis.com/css?family=Ubuntu:regular,bold&subset=Latin" rel="stylesheet" type="text/css" />
  <link href="../../css/bootstrap.css" rel="stylesheet" type="text/css" />
  <style>
    body { background-color: #ffffff; }
		div.huge {font-size: 300px; line-height: 1em;}
    #verify {cursor: pointer; }
    #qr_overlay {
	    position: absolute;
	    text-align: center;
	    top: 0;
	    left: 0;
	    width: 100%;
	    height: 100%;
	    z-index: 10000;
	}
	#qr_overlay_background {
	    position: absolute;
	    text-align: center;
	    top: 0;
	    left: 0;
	    width: 100%;
	    height: 100%;
	    background-color: #000;
	    -moz-opacity:0.7;
	    -khtml-opacity: 0.7;
	    opacity: 0.7;
	    z-index: 10000;
	}
	#IRMA_qr_main {
	    position: absolute;
	    text-align: center;
	    top: 0;
	    left: 0;
		-moz-opacity:1.0;
	    -khtml-opacity: 1.0;
	    opacity: 1.0;
	    width: 40%;
	    height: 400px;
	    margin-left: 30%;
	    margin-right: 30%;
	    margin-top: 10%;
	    background: white;
	    z-index: 10001;
	    -moz-border-radius: 12px;
  		border-radius: 12px;
  		padding-top: 20px;
  		padding-left: 20px;
  		padding-right: 20px;
	}
	</style>
</head>
<body>
  <div id="SnS_welcome" class="container">
    <div class="page-header">    
      <h1><img alt="Spuiten en Slikken" src="../../img/SnS_logo.png"> Age verification</h1>
    </div>
    <div class="row">
      <p>The website you requested has age restrictions, you have to be <strong>at least 16 years old</strong>.</p>
      <p><img id="verify" src="../../img/verify16.png"/></p>
    </div>

    <object classid="clsid:8AD9C840-044E-11D1-B3E9-00805F499D93" height="10" width="10">
      <param name="code" value="org.irmacard.scjs.SmartCardJS.class" />
      <param name="archive" value="../../smartcardjs.jar" />
      <param name="type" value="application/x-java-applet;version=1.6" />
      <param name="scriptable" value="true" />
      <param name="mayscript" value="true" />
      <embed type="application/x-java-applet;version=1.6" hidden="true" code="org.irmacard.scjs.SmartCardJS.class" archive="../../smartcardjs.jar" scriptable="true" mayscript="true" height="10" width="10" />
    </object>
  </div>

  <div id="qr_overlay" class="hide fade in">
  <div id="qr_overlay_background">
  </div>
  <div id="IRMA_qr_main">
  <span class="IRMA_text">Please scan this QR image with the IRMA app on your NFC-enabled phone and apply your IRMA card to your phone.</span>
  <br><img id="qr_image" src="" />
  </div>
  </div>
  
  
  <div id="IRMA_verify" class="hide fade in">
    <div class="IRMA_page">
      <div class="IRMA_container">
        <div class="IRMA_title">
          CHECKING CREDENTIAL(S)
        </div>
    
        <div class="IRMA_logo_top">
          <img src="../../img/irma_logo_1024px.png" width="264" height="211" />
        </div>
    
        <div class="IRMA_main_scherm">
          <div class="IRMA_content_icon">
            <img id="IRMA_status_icon" src="../../img/irma_icon_waiting_520px.png" width="130" height="130" />
          </div>
        
        <div class="IRMA_content_verify">
          <span class="IRMA_content_credential">Age: &ge;16</span>
          <span class="IRMA_content_status" id="IRMA_status_text"></span>
        </div>
            
        <div class="IRMA_verifier_logo">
          <img src="../../img/SnS_logo.png" width="174" />
        </div>
        
        <div class="IRMA_arrow">
            <img src="../../img/irma_arrow_312px.png" width="78" height="78">
        </div>
        
        <div class="IRMA_buttons">
          <button class="IRMA_button_gray_verify">HELP</button>
          <button id="IRMA_button_usephone" class="IRMA_button_gray_verify">USE PHONE</button>
          <button id="IRMA_button_verify" class="IRMA_button_primary">WAITING FOR CARD</button>
        </div>
      </div>
    </div>
  </div>
</div>

  <script src="../../js/jquery.js" type="text/javascript"></script>
  <script src="../../js/bootstrap.min.js" type="text/javascript"></script>
  <script src="../../js/smartcardjs.js" type="text/javascript"></script>
  <script type="text/javascript">
$(function() {
	SmartCardHandler.init();
	
  var startVerify = function () {
    disableVerify(); // Reset state
    console.log("Starting IRMA verification");
    $("#IRMA_verify").fadeIn();
    $("#SnS_welcome").hide();
    SmartCardHandler.bind("cardInserted", function() {
      SmartCardHandler.connectFirstCard();
      if (SmartCardHandler.selectApplet('6964656D6978')) {
        enableVerify();
      } else {
        $("#IRMA_status_icon").prop("src", "../../img/irma_icon_warning_520px.png");
        $("#IRMA_status_text").html("Inserted card is not an IRMA card");
      }
    });
    $("#IRMA_button_usephone").button().on("click",function(event) {
    	$.ajax({
            url: '/irma_web_service/protocols/verification/UitzendingGemist/ageLowerOver16?qr=true',
            contentType: 'application/json',
            data: JSON.stringify({crednr: 4}),
            type: 'POST',
            success: function(data) {
              console.log(data);
              $("#qr_image").attr("src", data.qr_url);
              $("#qr_overlay").show();
              checkInterval = window.setInterval(function(){
            	  var url = data.qr_url.substring(0,data.qr_url.lastIndexOf("/")) + '/status';
            	  $.get(url,function(data) {
            		  if (data.status !== "start") {
            			  $("#qr_overlay").hide();
            			  $("#IRMA_status_icon").prop("src", "../../img/irma_icon_ready_520px.png");
            			  $("#IRMA_status_text").html("Apply your IRMA card to your phone");
            			  $("#IRMA_button_verify").html("VERIFYING...");
            		  } 
            		  if (data.status === "success") {
            			  window.clearInterval(checkInterval);
            	            $("#IRMA_status_icon").prop("src", "../../img/irma_icon_ok_520px.png");
            	            $("#IRMA_status_text").html("Hit 'CONTINUE' to proceed to the website");
            	            $("#IRMA_button_verify").html("CONTINUE");
            	            $("#IRMA_button_verify").addClass("enabled");
            	            $("#IRMA_button_verify").button().on("click", function(event) {
            	              window.location = data.result;
            	            });          			  
            		  }
            		  if (data.status === "failure") {
            			  window.clearInterval(checkInterval);
            			  $("#IRMA_status_icon").prop("src", "../../img/irma_icon_missing_520px.png");
            		      $("#IRMA_status_text").html("Credential not found");
            		      $("#IRMA_button_verify").html("NOT FOUND");
            		  }
            	  }, "json");
              },500);
            }
          });
    	
    });
    SmartCardHandler.bind("cardRemoved", function() {
      disableVerify();
    });
    SmartCardHandler.connectFirstCard();
    if (SmartCardHandler.connectFirstCard() && SmartCardHandler.selectApplet('6964656D6978')) {
      enableVerify();
    }
  };
    
  var enableVerify = function () {
    $("#IRMA_status_icon").prop("src", "../../img/irma_icon_ready_520px.png");
    $("#IRMA_status_text").html("Hit 'VERIFY' to check your credential");
    $("#IRMA_button_verify").html("VERIFY");
    $("#IRMA_button_verify").addClass("enabled");
    $("#IRMA_button_verify").button().on("click", function(event) {
      $("#IRMA_button_verify").off("click");
      $("#IRMA_button_verify").removeClass("enabled");
      $("#IRMA_button_verify").html("VERIFYING...");
      $.ajax({
        url: '/irma_web_service/protocols/verification/UitzendingGemist/ageLowerOver16',
        contentType: 'application/json',
        data: JSON.stringify({crednr: 4}),
        type: 'POST',
        success: function(data) {
          console.log(data);
          nextAction = data;
          SmartCardHandler.connectFirstCard();
          response = SmartCardHandler.transmitCommandSet(data.commands);
          console.log(response);
          finishVerify(response, data);
        }
      });
    });
  };
    
  var disableVerify = function () {
    $("#IRMA_status_icon").prop("src", "../../img/irma_icon_waiting_520px.png");
    $("#IRMA_status_text").html("Insert your IRMA card or use your phone");
    $("#IRMA_button_verify").off("click");
    $("#IRMA_button_verify").removeClass("enabled");
    $("#IRMA_button_verify").html("WAITING FOR CARD...");
  } 
  
  var finishVerify = function (response, data) {
    console.log("Finished IRMA verification");
    if (response.smartcardstatus === "failed") {
      $("#IRMA_status_icon").prop("src", "../../img/irma_icon_missing_520px.png");
      $("#IRMA_status_text").html("Credential not found");
      $("#IRMA_button_verify").html("NOT FOUND");
    } else {
      $.ajax({
        url: data.responseurl,
        contentType: 'application/json',
        data: JSON.stringify(response),
        type: 'POST',
        success: function(data) {
          console.log(data);
          if (data.response === 'valid') {
            $("#IRMA_status_icon").prop("src", "../../img/irma_icon_ok_520px.png");
            $("#IRMA_status_text").html("Hit 'CONTINUE' to proceed to the website");
            $("#IRMA_button_verify").html("CONTINUE");
            $("#IRMA_button_verify").addClass("enabled");
            $("#IRMA_button_verify").button().on("click", function(event) {
              window.location = data.url;
            });
          } else {
            $("#IRMA_status_icon").prop("src", "../../img/irma_icon_missing_520px.png");
            $("#IRMA_status_text").html("Credential not found");
            $("#IRMA_button_verify").html("NOT FOUND");
          }
        }
      });
    }
  };

	$("#verify").on('click', function(event) {
		startVerify();
	});
});
  </script>

</body>
</html>